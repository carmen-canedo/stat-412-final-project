---
title: "Final Presentation"
author: "Mason Kellett, Carmen Canedo, Joseph Bernardi, David Leshchiner"
date: "December 1, 2020"
output: pdf_document
---
```{r Setup Mason Kellett, message=FALSE, warning=FALSE, include=FALSE}
source("setupMason.R")
source("setupCarmen.R")
```
## Athlete Participation  
```{r Problem Setup Mason Kellett, echo=FALSE, message=FALSE, warning=FALSE}
sport %>%
  group_by(Year) %>%
  summarise(Boys = sum(Boys),
            Girls = sum(Girls)) %>%
  left_join(enroll,
            by = "Year") %>%
  mutate(Pct_Boys = ((Boys/lag(Boys)-1)*100),
         Pct_Girls = ((Girls/lag(Girls)-1)*100),
         Pct_Students = ((Students/lag(Students)-1)*100)) %>%
  na.omit() %>%
  pivot_longer(cols = c(Pct_Boys,Pct_Girls,Pct_Students),
               names_to = "Type",
               values_to = "Change") %>%
  ggplot() +
  geom_smooth(aes(x = Year,y = Change, color = Type), size = 1.5, se = F) + 
  geom_hline(yintercept = 0,linetype = "dashed",color = "red")+
  xlim(2011,2018)+
  labs(title = "Percent Change in Total High School Athletes",
       subtitle = "Comapred with Percent Change in Total High School Students",
       y = "% Change",
       caption = "Data provided by NFHS") +
  theme_minimal() +
  scale_color_manual(values = wes_palette(name = "Moonrise2"),
                     name = "",
                     labels = c("Male Althletes","Female Athletes","Total Students")) +
  theme(legend.position = 'bottom') +
  theme(plot.title = element_text(face = "bold",size = 18,hjust = .5))
```
  Over the past 10 years there have been changes in the number of students who are participating in sport. As shown in the graph above, from about 2010 to 2015, both male and female participation changed fairly closely with the totla number of high school student in the United States. However, starting in about 2016 we see that the sport participation pulls away from the number of high school students. In this project report, we will analyze what charateristics of sport have caused the decline in sport participation.   
  

```{r By Gender and Sport Mason Kellett, echo=FALSE, message=FALSE, warning=FALSE}
enroll_pct_change <- enroll %>%
  arrange(Year) %>%
  mutate(pct_change = ((Students/lag(Students))-1) * 100) %>%
  na.omit()

sport %>%
  pivot_longer(cols = c(Boys,Girls)) %>%
  filter(Sport != "Baseball" | name != "Girls",
         Sport != "Football" | name != "Girls") %>%
  group_by(Sport, name) %>%
  arrange(Year, .by_group = TRUE) %>%
  mutate(pct_change = (value/lag(value) - 1) * 100) %>%
  ggplot() +
  geom_smooth(aes(x=Year,y = pct_change,color = Sport),size = 2, se = F) +
  facet_wrap(~name) +
  geom_hline(yintercept = 0,linetype = "dashed",color = "red")+
  labs(title = "Percent Change in High School Athletes by Sport",
       y = "% Change",
       caption = "Data provided by NFHS") +
  theme_minimal() +
  scale_color_manual(values = wes_palette(name = "Moonrise2")) +
  theme(legend.position = "bottom")+
  theme(plot.title = element_text(face = "bold",size = 18,hjust = .5)) 
```

### Hypothesis 1  
  
The first hypothesis is that participation levels will be different by sport.  
 
  As shown in the graph above, the only sport that showed a constant increase in sport participation was soccer. Football shows a negative trend, where the number of athletes participating is decreasing year over year. This helps support the hypothesis that the participation change is different by sport. This leads us to question which characteristics are common among sports with declining participation versus increasing participation.  
  

  
```{r Cost to Play Mason Kellett, echo=FALSE, message=FALSE, warning=FALSE}
 
cost <- cost %>%
  mutate(Price_Level = as_factor(if_else(Cost > 300, "Expensive","Inexpensive"))) %>%
  select(Sport, Price_Level)

sport %>%
  left_join(cost, by = "Sport") %>%
  pivot_longer(cols = c(Boys,Girls)) %>%
  filter(Sport != "Baseball" | name != "Girls",
         Sport != "Football" | name != "Girls") %>%
  group_by(Price_Level, Year) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  group_by(Price_Level) %>%
  arrange(Year, .by_group = T) %>%
  mutate(pct_change = ((value/lag(value))-1)*100) %>%
  ggplot() +
  geom_smooth(aes(x = Year, y = pct_change, color = Price_Level), size = 2,se = F) +
  geom_hline(yintercept = 0,linetype = "dashed",color = "red")+
  labs(title = "Percent Change in High School Athletes by Cost to Play",
       subtitle = "Compared to Percent Change in Overall High School Students (Black)",
       y = "% Change",
       color = "Price Level",
       caption = "Data provided by NFHS and MetroKids") +
  theme_minimal() +
  scale_color_manual(values = wes_palette(name = "Moonrise2")) +
  theme(legend.position = "bottom")+
  theme(plot.title = element_text(face = "bold",size = 16,hjust = .5)) +
  geom_smooth(data = enroll_pct_change, aes(x = Year, y = pct_change), size = 2, se = F, color = "black") +
  xlim(c(2011,2018))
```

### Hypothesis 2  

 More expensive sports will show a more consistent decline in sport participation. 

  Sports were split into two factors, expensive or inexpensive, depending on the sports average annual cost according to a MetroKids report. Based on this seperation, it was shown that the more expensive sport strayed significantly from the overall trendline for change in student population. The less expensive sports, even in 2018, followed pretty closely with the changes in student population. This leads to the conclusion that students are participating less frequently in sports that are consistently more expensive, which demonstrates how cost is a huge indicator of the decreasing sport participation. 
  
### Hypothesis 3

Sports with higher rates of injury will show a decline in participation.

# Injuries - Carmen Canedo

The main questions I looked into dealt with the potential impact of injuries in high school sports participation. So, within our overall hypothesis, I developed a few more that are specific to injuries.

My hypotheses were as follows:

  1. Contact sports will have a higher number of concussions than limited or no contact sports.
  2. Gender may be a factor in the overall rate of injuries in high school athletes.
  3. The risk of injury negatively impacts participation in high school sports.


## How many kids are getting hurt?
```{r Youth TBI Carmen}
# Getting rid of total counts
youth_ed_tbi_visits <- youth_ed_tbi_visits %>% 
  filter(Sport != "Total contact count") %>%
  filter(Sport != "Total limited contact count")

# Plotting bar graph
youth_ed_tbi_visits %>% 
  ggplot(aes(x = reorder(Sport, Count))) +
  geom_col(aes(y = Count,
               fill = `Contact Sport`)) +
  ylim(0, 55000) +
  scale_fill_manual(values = c("TRUE" = "#6eb4b8", "FALSE" = "#b8816e")) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Youth Emergency Room Visits among US Children for \nSports-Related Brain Injuries",
       subtitle = "Years: 2010 - 2016",
       caption = "Centers for Disease Control and Prevention (CDC): \n Morbidity and Mortality Weekly Report (March 2019)",
       x = "Sport",
       y = "Count")
```
In order to test my hypothesis that contact sports will have a higher number of concussions, I used data from the CDC’s Morbidity and Mortality Report. As you can see, Football, Basketball, & Soccer make up the majority of youth emergency room visits. Non-contact sports, therefore, appear to be less likely to result in Sports-Related brain injuries.

This suggests that there may be a correlation with participation and concussions, particularly with football.


## What demographics are most affected?
```{r Concussions by Gender Carmen}
# Pivoting longer
num_concussions_2017 <- num_concussions_2017 %>% 
  pivot_longer(cols = c(male, female)) %>% 
  rename(gender = name)

# Plotting Number of Concussions by Gender
num_concussions_2017 %>% 
   ggplot(aes(x = concussions, y = value, fill = gender)) +
   geom_col(position = "dodge") +
  scale_fill_manual(values = c("female" = "#706eb8",
                               "male" = "#91b86e"),
                    name = "Gender") +
  labs(title = "Percent of Concussions in US Youth That Play Sports by Gender",
       subtitle = "Year: 2017",
       caption = "CDC: Self-Reported Concussions from Playing a Sport or Being Physically Active
Among High School Students",
       x = "",
       y = "Percent") +
  theme_minimal()
```
Next, I compared the rates of concussions by gender. It is important to note that nearly 80% of US Youth did not get concussions from sports in 2017 when this survey was conducted. Of those that do, they are likely to only get one concussion, and it appears that males tend to have concussions slightly more often than females.

## What sports have the most injuries?
### Injuries by sport
```{r Combining Injury Totals Carmen}
# Iterating over and combining injury datasets
total_sport_injuries <- map_df(sports_injuries_type, combine_injury_totals)
```

```{r Lengthening Total Sports Injuries Carmen}
# Pivoting total sports injuries longer
total_sport_injuries <- Sport %>% 
  bind_cols(total_sport_injuries) %>% 
  select(-Activity) %>% 
  pivot_longer(cols = -Sport, names_to = "Injury Type", values_to = "Count")
```

```{r Boxplot of Injuries by Sport Carmen}
# Vector of colors
sports_colors <- c("#91b86e", "#956eb8", "#b86e90", "#6eb895", "#b8816e", "#b6b86e", "#706eb8")

# Plotting injuries by sport
total_injuries_boxplot <- total_sport_injuries %>% 
  ggplot(aes(x = Sport, y = Count, fill = Sport)) +
  geom_boxplot() +
  scale_fill_manual(values = sports_colors) +
  scale_y_continuous(breaks = seq(0, 175000, 25000)) +
  theme_minimal()
```

```{r Boxplot of Injuries by Sport Continued Carmen}
# Adding appropriate labels to histogram
total_injuries_boxplot +
  labs(title = "Variations in Amount of Injuries by Sport",
       subtitle = "Year: 2018",
       caption = "Colorado School of Public Health: \n Program for Injury Prevention, Education & Research") + 
  theme(axis.text.x = element_text(size = 7)) 
```

This led me to narrow in my focus, so I looked at the variations in injuries by sport in 2018. One thing I thought was really interesting was that Girl’s Soccer had the second highest mean. From the previous graphs we looked at, boy’s sports tended to have a higher number of injuries, so I had expected boys' contact sports to have higher numbers overall.

Football, though, clearly had the highest count of injuries. This could potentially contribute to public perception that contact sports like football are dangerous.


### Injuries by type
```{r Boxplot of Injuries by Type Carmen}
# Vector of colors
injury_colors <- c("#91b86e", "#956eb8", "#b86e90", "#6eb895", "#b8816e")

# Plotting boxplots of injury types
injury_type_boxplot <- total_sport_injuries %>% 
  ggplot(aes(x = `Injury Type`, y = Count, fill = `Injury Type`)) +
  geom_boxplot() +
  scale_fill_manual(values = injury_colors) +
  scale_y_continuous(breaks = seq(0, 175000, 25000)) +
  theme_minimal()

# Adding labels to graph
injury_type_boxplot +
  labs(title = "Variation in Most Common Injury Types",
       subtitle = "Year 2018",
       caption = "Colorado School of Public Health: \n Program for Injury Prevention, Education & Research")
```

Another variable of interest I looked at was the variation of injury type in 2018. It appears that sprains are the most common injury, followed by concussion.

## How have injuries rates changed over time?
### Diagnosis by year, color by type
```{r Lengthening Diagnosis Table Carmen}
# Pivoting diagnosis dataset
diagnosis_by_year <- diagnosis_by_year %>% 
  rename(Diagnosis = X1) %>% 
  filter(Diagnosis != "Total") %>% 
  pivot_longer(cols = !Diagnosis, names_to = "Year", values_to = "Percent")
```

```{r Formatting Diagnosis Carmen}
# Temporary variable holding all year values
temp_year <- diagnosis_by_year$Year

# Temporary variable holding all percent values
temp_perc <- diagnosis_by_year$Percent

# Using regex to clean observations
temp_year <- temp_year %>% 
  str_replace_all(pattern = ",", replacement = "") %>% 
  str_replace_all(pattern = "[[:punct:]]\\d{2}", replacement = "") %>% 
  as.integer()

# Using regex to get rid of percent sign
temp_perc <- temp_perc %>% 
  str_replace_all(pattern = "%", replacement = "") %>% 
  as.numeric()

# Joining new columns and renaming variables for clarity
diagnosis_by_year <- diagnosis_by_year %>% 
  select(-Year, -Percent) %>% 
  bind_cols(temp_year, temp_perc) %>% 
  rename(Year = `...2`) %>% 
  rename(Percent = `...3`)
```

```{r Scatterplot for Diagnosis by Sport Carmen}
# Creating scatter plot of diagnoses over time by type
diagnosis_time <- diagnosis_by_year %>% 
  ggplot(aes(x = Year, y = Percent, color = Diagnosis)) +
  facet_wrap(~ Diagnosis, scales = "free") +
  geom_point() +
  geom_smooth() +
  scale_color_manual(values = injury_colors) +
  theme_minimal()
```

```{r Scatterplot Formatting Carmen}
# Adding appropriate labels to diagram
diagnosis_time +
  labs(title = "Trends in Injury Diagnosis",
       subtitle = "Years: 2005 - 2018",
       caption = "Colorado School of Public Health: Program for Injury Prevention, Education & Research")
```

The next aspect I analyzed is how injury diagnoses have changed over time. This data comes from the Colorado School of Public Health’s Program for Injury Prevention, Education & Research, and this study collected data on the main injury diagnoses high school students received from 2005-2018.

Concussions were the only type of injury to see an increase over the course of those 13 years, and it nearly doubled. It is possible that this large increase in concussions has led to a decrease in contact sports.


# Participation
## Who participates in sports?
```{r Map Data Carmen}
# Loading latitude and longitude data
usa_map <- map_data("state")
```

### Boys Participants Map
```{r Boy Participation Carmen}
# Lengthening boys participation data
boys_participation_long <- all_boys_athletes_states %>% 
  pivot_longer(cols = !State, names_to = "Sports", values_to = "Count")

# Making state names lowecase to match `usa_map`
boys_participation_long$State <- tolower(boys_participation_long$State)

# Plotting choropleth map
boys_participation_map <- boys_participation_long %>% 
  ggplot(aes(fill = Count)) +
  geom_map(aes(map_id = State), map = usa_map) +
  expand_limits(x = usa_map$long, y = usa_map$lat) +
  facet_wrap( ~ Sports)
```

```{r Boy Participation Map Carmen}
# Adding labels to map
boys_participation_map +
  theme_void() +
  labs(title = "Counts of Participation in Boy's Sports by State",
       subtitle = "Year: 2018",
       caption = "High School Participation Survey Archive") +
    theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_distiller(palette = "Greens", trans = "reverse")
```

As I started wrapping up my analysis on injury, I began to look at sports participation by gender and by state for 2018. 

Here, we can see the count of participants in 48 of the states, separated by sport. One of the most notable parts of this graph is that it appears the highest number of participants is for football in Texas. This was unexpected to me because of the data we have seen in the past few slides that football has a higher rate of injury.

The next most popular sports appear to be basketball and soccer, both of which had the highest number of participants in Texas and California.


### Boys Programs Availability Map
```{r Boys Programs Carmen}
# Lengthening program data
boys_programs_long <- all_boys_programs_states %>% 
  pivot_longer(cols = !State, names_to = "Sports", values_to = "Count")
  
# Making state names lowercase
boys_programs_long$State <- tolower(boys_programs_long$State)

# Plotting choropleth map
boys_programs_count <- boys_programs_long %>% 
  ggplot(aes(fill = Count)) +
  geom_map(aes(map_id = State), map = usa_map) +
  expand_limits(x = usa_map$long, y = usa_map$lat) +
  facet_wrap( ~ Sports)
```

```{r Boys Programs Map Carmen}
# Adding lables
boys_programs_count +
  theme_void() +
  labs(title = "Counts of Programs for Boy's Sports by State",
       subtitle = "Year: 2018",
       caption = "High School Participation Survey Archive") +
    theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_distiller(palette = "Purples", trans = "reverse")
```

I next looked at the availability of sports programs by state for the same year. As you can see, there tends to be a slightly higher number of programs overall for basketball than for the other sports. 

It is unclear whether sports with high rates of injuries have less programs available through school or travel teams, etc. There are several other factors that could play into the number of programs available like cost.


### Girls Participants Map
```{r Gir Participation Carmen}
# Lengthening girls participation data
girls_participation_long <- girl_athletes_states %>% 
  select(-starts_with("X"), -Football) %>% 
  pivot_longer(cols = !State, names_to = "Sports", values_to = "Count")
  
# Making state names lowercase
girls_participation_long$State <- tolower(girls_participation_long$State)

# Plotting choropleth map
girls_participation_map <- girls_participation_long %>% 
  ggplot(aes(fill = Count)) +
  geom_map(aes(map_id = State), map = usa_map) +
  expand_limits(x = usa_map$long, y = usa_map$lat) +
  facet_wrap( ~ Sports)
```

```{r Girl Participation Map}
# Adding labels
girls_participation_map +
  theme_void() +
  labs(title = "Counts of Participation in Girl's Sports by State",
       subtitle = "Year: 2018",
       caption = "High School Participation Survey Archive") +
    theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_distiller(palette = "Greens", trans = "reverse")
```

The highest number of female participants appears to be for volleyball. This sport had the lowest average injury in the box plots we saw earlier, and this potentially supports our hypothesis as well, as it has lower number of injuries and more participation.

### Girls Progams Map
```{r Girls Programs Carmen}
# Lengthening data
girls_programs_long <- girl_programs_states %>% 
  select(-starts_with("X"), -Football) %>% 
  pivot_longer(cols = !State, names_to = "Sports", values_to = "Count")

# Making state names lowercase
girls_programs_long$State <- tolower(girls_programs_long$State)

# Plotting chropleth map
girls_programs_count <- girls_programs_long %>% 
  ggplot(aes(fill = Count)) +
  geom_map(aes(map_id = State), map = usa_map) +
  expand_limits(x = usa_map$long, y = usa_map$lat) +
  facet_wrap( ~ Sports)
```

```{r Girl Participation Carmen}
# Adding labels
girls_programs_count +
  theme_void() +
  labs(title = "Counts of Programs for Girls's Sports by State",
       subtitle = "Year: 2018",
       caption = "High School Participation Survey Archive") +
    theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_distiller(palette = "Purples", trans = "reverse")
```

Here is the availability of sports programs for girls by state. It appears the states where the highest number of programs are also happen to be for volleyball. It is possible that schools and sports organizations are more likely to invest in sports programs that are less likely to lead to injury.

# Conclusion
## Public opinion
```{r Factor Levels Carmen}
# Vector of statements from survey
text_statements <- c("Players who suffer a head injury should be required to take a minimum set amount of time off from playing to recover.",
                     "Helmets should be changed to better protect against concussions.",
                     "The risks of playing football are widely known and players participate at their own risk.",
                     "There should be a standardized test used to determine if and when injured players at all levels may return to the field.",
                     "Aggressive tackles which are more prone to leading to head injuries should be restricted in youth football.")

# Vector of survey levels
survey_levels <- c(
  "Strongly agree",
  "Somewhat agree",
  "Somewhat disagree",
  "Strongly disagree",
  "Not at all sure"
) %>% 
  as_factor()
```

```{r Lengthening Data Carmen}
# Getting rid of Statement column to convert numbers to percents
survey_interim <- survey_tbi_effects %>% 
  select(-Statement)

# Calculating percentages
data_percentage <- survey_interim %>% 
  apply(2,
        function(x){
          perc <- x / sum(x)
          round(perc, digits = 2)
          })

# Converting to tibble and adding final column so it equals 1
diff_interim <- data_percentage %>% 
  as_tibble() %>% 
  select_if(is.numeric) %>% 
  mutate(sum = rowSums(.[1:5])) %>% 
  mutate(diff = 1 - sum)

# Saving into data_percentage
data_percentage <- diff_interim %>% 
  select(-sum)
  

# Adding the statement column back
data_percentage <- cbind(survey_tbi_effects$Statement, data_percentage) %>% 
  as_tibble()  %>% 
  slice(1:5)


# Renaming column
data_percentage <- data_percentage %>% 
  rename(Statement = `survey_tbi_effects$Statement`)

# Pivot long
long_percentage <- data_percentage %>% 
  pivot_longer(cols = contains("r")) %>% 
  rename(response = name)

```

```{r Stacked Bar Graph Carmen}
# Vector of colors and lavels
set_colors <- c("#91b86e", "#956eb8", "#b86e90", "#6eb895", "#b8816e", "#b6b86e")
xlabels <- c("1", "2", "3", "4", "5")

# Making graph
stacked_survey <- long_percentage %>% 
  ggplot(aes(x = Statement, y = value, fill = response)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = set_colors, name = "Response") +
  scale_x_discrete(labels = xlabels) +
  labs(title = "Survey Responses on The Long-Term Effects of Concussions in Sports",
       subtitle = "2014",
       caption = "Source: Harris Interactive | The Harris Poll #92",
       y = "") +
  theme_light()

stacked_survey
```

Lastly, I felt that one of the best ways to get an idea of how the public views sports-related brain injuries in general was to look at a public opinion poll. This survey was conducted by Harris Interactive and it asked its participants to rate to what extent they agree or disagree with 5 statements.

Some of the main takeaways from this graph are that:

  + A quarter of respondents did not believe in setting a minimum amount of time to recover from brain injuries - instead they felt that helmets and protective gear should be modified to better protect athletes.
  + Additionally, nearly a quarter of respondents felt that risk of injury in football is widely known. So perhaps there is a consensus that the sport itself isn’t going to change, but it is the responsibility of athletes to decide whether or not they will put themselves at risk. This statement in particular really stood out to me as tying back to my hypothesis that risk negatively affects participation.

# The Impact of Academics on Sports Participation
# Joseph Bernardi

  An essential part of our hypothesis is that an increased amount of focus on academics will lower the participation in sports, as students will have less time to devote to sports.

  Initially, I tested AP enrollment against the participation in high school sports, but found no significant correlation. I concluded that this may be due to other variables such as the differing availability of AP programs at school. Therefore, I began to analyze the relationship between SAT enrollment (per capita) and average score, as well as boys and girls sports participation (per capita).


### SAT Enrollment and Average Score

```{r State Sports Participation Data (Joseph Bernardi), echo=FALSE, message=FALSE, warning=FALSE}

library(tidyverse)
library(ggplot2)
library(ggthemes)

participationdata <- read.csv("participation_data.csv")

# Condense data to get total sports participation for each state, for the 2018/2019 school year
participationdata2 <- participationdata %>%
  subset(year = "2018/2019") %>%
  select(state, boys_participation, girls_participation) %>%
  group_by(state) %>%
  summarise(state.boys_partic = sum(boys_participation), state.girls_partic = sum(girls_participation)) %>%
  na.omit()

statepopdata <- read.csv("https://raw.githubusercontent.com/JoshData/historical-state-population-csv/primary/historical_state_population_by_year.csv")

# Adjust state participation by state population
statepopdata <- statepopdata %>%
  rename("state" = "AK", "Population" = X135000) %>%
  subset(X1950 == 2019) %>%
  select(state, Population)

percap.participation <- participationdata2 %>%
  inner_join(statepopdata, by = "state") %>%
  group_by(state) %>%
  summarise(boys.participation.percapita = state.boys_partic / Population, girls.participation.percapita = state.girls_partic / Population, total.participation.percapita = (state.boys_partic + state.girls_partic) / Population, Population) %>%
  pivot_longer(cols = c(boys.participation.percapita, girls.participation.percapita), names_to = "Gender", values_to = "Per Capita Participation")

# Plot for participation by state and gender
ggplot(data=percap.participation, aes(x=state, y=`Per Capita Participation`, fill=Gender)) +
geom_bar(stat="identity", width = 0.8, position=position_dodge(width = 0.8)) + theme(axis.text=element_text(size=7, angle=45), legend.position="bottom") + scale_fill_discrete(name = "Gender", labels = c("Boys Participation", "Girls Participation")) + ggtitle("Sports Participation(Per Capita) by State and Gender in 2019")

# Plot for participation by state
ggplot(data=percap.participation, aes(x=state, y=total.participation.percapita)) + theme_calc() + geom_bar(stat="identity", width = 0.6, fill = "dark green") + theme(axis.text=element_text(size=7, angle=45)) + ggtitle("Sports Participation (Per Capita) by State in 2019")

```
  
  
Here we can observe that different states have varying levels of participation when adjusting for population size. In general, boys tend to participate in sports more than girls. Iowa and Nebraska are among the highest for per capita participation. We can also observe similar trends when comparing total participation between states.


```{r SAT Data by State (Joseph Bernardi), echo=FALSE, message=FALSE, warning=FALSE}

# Load SAT data
SAT_data <- read.csv("SAT_data.csv")

# Create a dataframe that includes metrics in a per capita sense
Sports.vs.SAT <- percap.participation %>%
  inner_join(SAT_data, by = "state") %>%
  select(state, total.participation.percapita, tooktest, avg_score, Population) %>%
  unique() %>%
  group_by(state) %>%
  summarise(tooktest.percapita = tooktest / Population, total.participation.percapita, avg_score, tooktest, Population)

# Plot for SAT Enrollment per capita
ggplot(data=Sports.vs.SAT, aes(x=state, y=tooktest.percapita)) + theme_stata() +
  geom_bar(stat="identity", width = 0.6, fill = "orange") + theme(axis.text=element_text(size=7, angle=45)) + ggtitle("SAT Enrollment (Per Capita) by State in 2019")

# Plot for SAT avg score per capita
ggplot(data=Sports.vs.SAT, aes(x=state, y=avg_score)) + theme_stata() +
  geom_bar(stat="identity", width = 0.6, fill = "light blue") + theme(axis.text=element_text(size=7, angle=45)) + ggtitle("SAT Average Total Score by State in 2019")

```

Here, for reference, we can observe the SAT enrollment per capita and average SAT score for each state in 2019.

### Comparing Sports Participation with SAT Enrollment and Average Score

```{r Comparing SAT and Sports Data (Joseph Bernardi), echo=FALSE, message=FALSE, warning=FALSE}

# Plots for comparing SAT Enrollment with sports data 
Sports.vs.SAT %>%
  ggplot(aes(x = reorder(state, total.participation.percapita), y = tooktest.percapita)) + theme_calc() + geom_bar(stat="identity", width = 0.6, fill = "dark red") + theme(axis.text=element_text(size=7, angle=45)) + ggtitle("Sports Participation VS SAT Enrollment") + xlab("States from Least to Greatest in Sports Participation Per Capita") + ylab("SAT Enrollment Per Capita")

Sports.vs.SAT %>%
  ggplot(aes(x = total.participation.percapita, y = tooktest.percapita, group = 1)) + theme_calc() + geom_line(stat="identity", width = 0.6, color = "dark red") + geom_point() + geom_text(aes(label=state), size = 3, hjust=-0.3, vjust=0) + theme(axis.text=element_text(size=7, angle=45)) + ggtitle("Sports Participation VS SAT Enrollment") + xlab("Sports Participation Per Capita") + ylab("SAT Enrollment Per Capita")


```


  First, we can examine the relationship between sports participation per capita and SAT enrollment per capita. We can observe this relationship in a couple ways, the first of which is ordering the states from least to greatest in terms of sports participation, and plotting the enrollment per capita on a bar chart. Secondly, we may use a line plot to compare the two values, while portraying the states as point labels.
  
  After examining both of these visualizations, it is apparent that there is no visible correlation between sports participation and SAT enrollment, as the data points are flat, and do not entail a positive or negative correlation.
  
```{r Comparing SAT and Sports Data Pt.2 (Joseph Bernardi), echo=FALSE, message=FALSE, warning=FALSE}

# Plots for comparing SAT Score with sports data 
Sports.vs.SAT %>%
  group_by(state) %>%
  summarise(sport.score_ratio = total.participation.percapita / avg_score, Population, total.participation.percapita, avg_score) %>%
  ggplot(aes(x = reorder(state, total.participation.percapita), y = avg_score)) + theme_calc() + geom_bar(stat="identity", width = 0.6, fill = "dark blue") + theme(axis.text=element_text(size=7, angle=45)) + ggtitle("Sports Participation VS Average SAT Score") + xlab("States from Least to Greatest in Sports Participation Per Capita")

Sports.vs.SAT %>%
  group_by(state) %>%
  summarise(sport.score_ratio = total.participation.percapita / avg_score, Population, total.participation.percapita, avg_score) %>%
  ggplot(aes(x = total.participation.percapita, y = avg_score, group = 1)) + geom_point() + geom_text(aes(label=state), size = 3, hjust=-0.3, vjust=0) + theme_calc() + geom_line(stat="identity", width = 0.6, color = "dark blue") + theme(axis.text=element_text(size=7, angle=45)) + ggtitle("Sports Participation VS Average SAT Score") + xlab("Sports Participation Per Capita")


```

  Similar visualization techniques can be used to examine the relationship between sports participation per capita and the average SAT score for each state. A similar conclusion can be inferred from these visualizations, in that there seems to be no visible correlation between the two variables. Neither plot infers a positive or negative correlation, as there is no clear trend in the data points.
  
  In summary, the data distinctly portrays that there is no correlation between SAT enrollment/scores and participation in sports.
  
  
### Comparing Sports Participation and Youth Employment in High School

  Although our initial hypothesis has seemed to be refuted, let us expand a little bit on this concept of work. Lots of students work jobs after school, would this be more detrimental to sports participation?
  
```{r Comparing Sports Participation and Youth Employment (Joseph Bernardi), echo=FALSE, message=FALSE, warning=FALSE}

employmentdata <- read.csv("employment_data.csv")

participationdata3 <- participationdata

# Take Year from school year
participationdata3$year <- gsub("^.{0,5}", "", participationdata3$year)

participationdata3$year <- as.integer(as.character(participationdata3$year))

# Group employment and sports by Year
employment.vs.sports <- participationdata3 %>%
  rename(Year = year) %>%
  select(Year, boys_participation, girls_participation) %>%
  group_by(Year) %>%
  summarise(state.boys_partic = sum(boys_participation), state.girls_partic = sum(girls_participation), total.partic = state.boys_partic + state.girls_partic) %>%
  inner_join(employmentdata, by = "Year") %>%
  drop_na()


# Shift data to percent change format
employment.vs.sports <- employment.vs.sports %>%
  subset(Year > 2010) %>%
  arrange(Year) %>%
  mutate(pct.emp = (percent_employment - lag(percent_employment))/lag(percent_employment)*100) %>%
  mutate(pct.partic = (total.partic - lag(total.partic))/lag(total.partic)*100) %>%
  mutate(pct.boys = (state.boys_partic - lag(state.boys_partic))/lag(state.boys_partic)*100) %>%
  mutate(pct.girls = (state.girls_partic - lag(state.girls_partic))/lag(state.girls_partic)*100)
  
# Plot percent change data
ggplot(data=employment.vs.sports, aes(x=Year, y=pct.partic, group=1)) +
  geom_line(aes(y = pct.boys, color = "blue")) + geom_line(aes(y = pct.girls, color = "red")) + geom_line(aes(y = pct.emp, color = "green")) + geom_line(aes(y = pct.partic, color = "purple")) + ylab("Percent Change") + ggtitle("Percent Change of Youth Employment and Sports Participation\n in Boys and Girls") + scale_color_discrete(name = "Type", labels = c("% Change in\n Girls Sports\n Participation", "% Change in\n High School\n Aged Employment", "% Change in\n Boys Sports\n Participation", "% Change in\n Total Sports\n Participation")) + theme_pander() +  theme(legend.position="bottom")
  

```

  Here, we can observe that there is a noticeable positive trend in the data, inferring there to be a positive relationship between sports participation and youth employment. This defies our expectation from our hypothesis, that an increase workload would explain less involvement in sports. However, it seems like this is the exact opposite. This may have an economic factor to it, in that when the economy is doing well, students' families will be able to do better financially and afford fees for extracurricular activities for their children and not need them to necessarily get a job.
  
  To conclude, it is apparent that this section of our hypothesis has been proven to be incorrect, as SAT data shows a constant trend, while youth employment portrays the opposite of our expectations.


# David Leshchiner Final Report for the group Project


```{r}
source("scriptDavid.R") #Script contains libraries and functions
```

### Data sourced from the National Federation of State High School Associations (NFHS)

# Hypothesis One

I firstly believe that there is a correlation between an increase in high schools offering soccer programs and participation in high school soccer that crosses gender divides

# Hypothesis Two

Secondly I believe that there are regional variations in the amount of school offerings of soccer programs, and this variation might be gendered

## Manipulating the Data

```{r}
gbsoccer <- read_csv("data/partcipation_statistics_12_01_202009_22.csv")
head(gbsoccer, 3)
```

```{r}
gbsoccer1 <- gbsoccer %>% #Manipulating data to graph nationwide percent change by year
  group_by(Year) %>%
  summarise(Boys_School = sum(`Boys School`),
            Girls_School = sum(`Girls School`)) %>%
  mutate(Boys_change = (Boys_School/lag(Boys_School) - 1) * 100) %>%
  mutate(Girls_change = (Girls_School/lag(Girls_School) - 1) * 100) %>%
  na.omit()
         

head(gbsoccer1, 5)

gbsoccer1a <- gbsoccer1 %>%
  mutate(Girls_School = (Girls_School/1000))

gbsoccer1b <- gbsoccer %>% #Manipulating data to graph nationwide participation change by year
  group_by(Year) %>%
  summarise(Boys_Participation = sum(`Boys Participation`),
            Girls_Particpation = sum(`Girls Participation`)) 

head(gbsoccer1b, 5)
```
```{r}
gbsoccer1 %>%  #Formatted Data with KableExtra package
  kbl(caption = "US High Schools with Soccer Programs") %>%
  kable_classic(position = "center") 
```
## Graphing the Data

```{r}
ggplot(gbsoccer1) +     #Using ggplot to graph girls participation in high school soccer and the percentage change of schools offering the sport
  geom_col(aes(x = Year, y = Girls_change), fill = "#F2312E") +
  guides(fill = FALSE) +
  geom_line(aes(x = Year, y = Girls_change, group = 1), color= "#037EFC", size = 1.5) +
    theme(axis.text.x = element_text(angle = 45, vjust = (1.1), hjust = (1.1))) + 
  labs(title = "Annual Change in Schools offering Girls Soccer Programs", x = "Season", y = "Percent Change")

ggplot(gbsoccer1b) +
  geom_line(aes(x = Year, y = Girls_Particpation, group = 1), color = "orange", size = 2) +
  theme(axis.text.x = element_text(angle = 45, vjust = (1.1), hjust = (1.1)))+ 
  labs(title = "Amount of HS Girls in Soccer Programs", x = "Season", y = "Amount of Girls")
```

From the data it is visible that there is some correlation between an increase in high schools offering soccer programs for girls and an increase in participation for girls in high school soccer. The data is positively correlated, and there are instances of correlation from interval to interval as is the case from 2006/07 or 2008/09 or 2009/10 when there were similar increases and decreases in both graphs.


```{r}
ggplot(gbsoccer1) +   #Graphs similar to girls in terms of code
  geom_col(aes(x = Year, y = Boys_change), fill = "#037EFC") +
  guides(fill = FALSE) +
  geom_line(aes(x = Year, y = Boys_change, group = 1), color= "#F2312E", size= 1.5) +
    theme(axis.text.x = element_text(angle = 45, vjust = (1.1), hjust = (1.1))) +
  labs(title = "Annual Change in Schools offering Boys Soccer Programs", x = "Season", y = "Percent Change", subtitle = "With Outlier")

ggplot(gbsoccer1) +
  geom_col(aes(x = Year, y = Boys_change), fill = "#037EFC") +
  guides(fill = FALSE) +
  ylim(0, 5) +
  xlim("2003/2004", "2004/2005", "2005/2006", 
       "2006/2007","2007/2008", "2008/2009", "2009/2010", "2010/2011", "2011/2012", "2012/2013", "2013/2014", 
      "2014/2015","2015/2016", "2016/2017", "2017/2018") +     #Might have been able to use stringr but this works as well
  geom_line(aes(x = Year, y = Boys_change, group = 1), color= "#F2312E", size= 1.5) +
    theme(axis.text.x = element_text(angle = 45, vjust = (1.1), hjust = (1.1))) +
  labs(title = "Annual Change in Schools offering Boys Soccer Programs", x = "Season", y = "Percent Change", subtitle = "Without Outlier")


ggplot(gbsoccer1b) +
  geom_line(aes(x = Year, y = Boys_Participation, group = 1), color = "yellow", size = 2) +
  theme(axis.text.x = element_text(angle = 45, vjust = (1.1), hjust = (1.1))) + 
  labs(title = "Amount of HS Boys in Soccer Programs", x = "Season", y = "Amount of Boys")
```

From the data it is visible that there is some correlation between an increase in high schools offering soccer programs for boys and an increase in participation for boys in high school soccer. The data is positively correlated, and there are instances of correlation from interval to interval as is the case from 2006/07 or 2008/09 or 2009/10 when there were similar increases and decreases in both graphs. There are two graphs because 2018/19 is an outlier which hampers the visualization of the other data points. The first graph includes it and shows how large it is. The outlier might be an error or due to a change in methodology, or there could have been a massive increase in soccer programs offered to boys. However, there wasn't a large increase in boys soccer participation afterword, so much analysis is required. 

## Part Two: Manipulating More Data

```{r}
RegionState <- str_c(gbsoccer$State, state.region, sep = "_", collapse = NULL) #Used stringr to combine the state character string from the dataset and the state.region character string found pre-installed in R
```

```{r}
RegionState2 <- str_split_fixed(RegionState, "_", 2)  
gbsoccerPLOT <- gbsoccer %>%
  cbind(RegionState2) %>%
  select(Year, `Boys School`, `Girls School`, `Girls Participation`, `Boys Participation`, `2`) %>%
  rename("Region" = `2`)
gbsoccerPLOT <- as.data.frame(unclass(gbsoccerPLOT))
gbsoccerPLOT
```

## Graphing the data

```{r}
MakeBoysRegionPlot("West") #Used function to make the next eight plots
MakeBoysRegionPlot("South")
MakeBoysRegionPlot("Northeast")
MakeBoysRegionPlot("North Central")
```

```{r}
MakeGirlsRegionPlot("West")
MakeGirlsRegionPlot("South")
MakeGirlsRegionPlot("Northeast")
MakeGirlsRegionPlot("North Central")
```


```{r}
gbsoccerPLOT1 <- gbsoccerPLOT %>% #Manipulating data to graph region wide percent change by year for school offerings of soccer
  group_by(Region, Year) %>%
  summarise(Boys_School = sum(Boys.School),
            Girls_School = sum(Girls.School)) %>%
  mutate(Boys_change = (Boys_School/lag(Boys_School) - 1) * 100) %>%
  mutate(Girls_change = (Girls_School/lag(Girls_School) - 1) * 100) %>%
  na.omit()

gbsoccerPLOT1$Year = as.Date(as.character(gbsoccerPLOT1$Year),"%Y")
gbsoccerPLOT1$Year = year(gbsoccerPLOT1$Year)
gbsoccerPLOT1
```
```{r}
ggplot(gbsoccerPLOT1) +   #Used Facet grid to plot regional change in boys soccer program
  geom_col(aes(x = Year, y = Boys_change, fill = Region)) +
  guides(fill = FALSE) +
  facet_wrap(vars(Region)) +
  geom_smooth(aes(x = Year, y = Boys_change, group = Region), color= "#F2312E", size= 1, se = F) +
  labs(title = "Annual Regional Change in Schools offering Boys Soccer Programs", x = "Season", y = "Percent Change")
```

```{r}
ggplot(gbsoccerPLOT1) +   #Used Facet grid to plot regional change in girls soccer program
  geom_col(aes(x = Year, y = Girls_change, fill = Region)) +
  guides(fill = FALSE) +
  facet_wrap(vars(Region)) +
  geom_smooth(aes(x = Year, y = Girls_change, group = Region), color= "#F2312E", size= 1, se = F) +
  labs(title = "Annual Regional Change in Schools offering Girls Soccer Programs", x = "Season", y = "Percent Change")
```

Both of these graphs demonstrate that the growth of the sport has large regional variation from season to season which ends up making the growth rate of each region somewhat similar with the exception of the West which is currently growing. Furthermore, the data shows that there is a correlation between the growth of girls and boys soccer programs which makes some common sense since a school wants to be gender inclusive. 

```{r}
gbsoccerPLOT1 %>% #Used Facet grid to plot regional change in boys soccer program but divided country into just two regions: The Coast and the interior
  mutate(Region = fct_collapse(Region,
                                Coast = c("Northeast", "West"),
                                Interior = c("North Central", "South"))) %>% 
  ggplot() + 
  geom_col(aes(x = Year, y = Boys_change, fill = Region)) +
  guides(fill = FALSE) +
  facet_wrap(vars(Region)) +
  geom_smooth(aes(x = Year, y = Boys_change, group = Region), color= "#F2312E", size= 1, se = F) +
  labs(title = "Annual Regional Change in Schools offering Boys Soccer Programs", x = "Season", y = "Percent Change")
```

```{r}
gbsoccerPLOT1 %>% #Used Facet grid to plot regional change in boys soccer program but divided country into just two regions: The Coast and the interior
  mutate(Region = fct_collapse(Region,
                                Coast = c("Northeast", "West"),
                                Interior = c("North Central", "South"))) %>% 
  ggplot() + 
  geom_col(aes(x = Year, y = Girls_change, fill = Region)) +
  guides(fill = FALSE) +
  facet_wrap(vars(Region)) +
  geom_smooth(aes(x = Year, y = Girls_change, group = Region), color= "#F2312E", size= 1, se = F) +
  labs(title = "Annual Regional Change in Schools offering Girls Soccer Programs", x = "Season", y = "Percent Change")
```

The reduction of the US into just two regions was done because many commentators describe the US as having a coastal center and a rural interior which is an oversimplification but for the purposes of this exercise I used that belief to demonstrate that there is a slight increase in soccer programs being offered in the US Coast and less soccer programs being offered in the US interior. The graph is a bit wonky as it adds up negative and positive numbers to form strange columns but the regression line running through it takes them into account and shows the trend line. This trend is visible among boys and girls soccer programs
