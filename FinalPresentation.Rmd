---
title: "FinalPresentation"
author: "Mason Kellett, Carmen Canedo"
date: "December 1, 2020"
output: pdf_document
---
```{r Setup Mason Kellett, message=FALSE, warning=FALSE, include=FALSE}
source("setupMason.R")
source("setupCarmen.R")
```
## Athlete Participation  
```{r Problem Setup Mason Kellett, echo=FALSE, message=FALSE, warning=FALSE}
sport %>%
  group_by(Year) %>%
  summarise(Boys = sum(Boys),
            Girls = sum(Girls)) %>%
  left_join(enroll,
            by = "Year") %>%
  mutate(Pct_Boys = ((Boys/lag(Boys)-1)*100),
         Pct_Girls = ((Girls/lag(Girls)-1)*100),
         Pct_Students = ((Students/lag(Students)-1)*100)) %>%
  na.omit() %>%
  pivot_longer(cols = c(Pct_Boys,Pct_Girls,Pct_Students),
               names_to = "Type",
               values_to = "Change") %>%
  ggplot() +
  geom_smooth(aes(x = Year,y = Change, color = Type), size = 1.5, se = F) + 
  geom_hline(yintercept = 0,linetype = "dashed",color = "red")+
  xlim(2011,2018)+
  labs(title = "Percent Change in Total High School Athletes",
       subtitle = "Comapred with Percent Change in Total High School Students",
       y = "% Change",
       caption = "Data provided by NFHS") +
  theme_minimal() +
  scale_color_manual(values = wes_palette(name = "Moonrise2"),
                     name = "",
                     labels = c("Male Althletes","Female Athletes","Total Students")) +
  theme(legend.position = 'bottom') +
  theme(plot.title = element_text(face = "bold",size = 18,hjust = .5))
```
  Over the past 10 years there have been changes in the number of students who are participating in sport. As shown in the graph above, from about 2010 to 2015, both male and female participation changed fairly closely with the totla number of high school student in the United States. However, starting in about 2016 we see that the sport participation pulls away from the number of high school students. In this project report, we will analyze what charateristics of sport have caused the decline in sport participation.   
  

```{r By Gender and Sport Mason Kellett, echo=FALSE, message=FALSE, warning=FALSE}
enroll_pct_change <- enroll %>%
  arrange(Year) %>%
  mutate(pct_change = ((Students/lag(Students))-1) * 100) %>%
  na.omit()

sport %>%
  pivot_longer(cols = c(Boys,Girls)) %>%
  filter(Sport != "Baseball" | name != "Girls",
         Sport != "Football" | name != "Girls") %>%
  group_by(Sport, name) %>%
  arrange(Year, .by_group = TRUE) %>%
  mutate(pct_change = (value/lag(value) - 1) * 100) %>%
  ggplot() +
  geom_smooth(aes(x=Year,y = pct_change,color = Sport),size = 2, se = F) +
  facet_wrap(~name) +
  geom_hline(yintercept = 0,linetype = "dashed",color = "red")+
  labs(title = "Percent Change in High School Athletes by Sport",
       y = "% Change",
       caption = "Data provided by NFHS") +
  theme_minimal() +
  scale_color_manual(values = wes_palette(name = "Moonrise2")) +
  theme(legend.position = "bottom")+
  theme(plot.title = element_text(face = "bold",size = 18,hjust = .5)) 
```

### Hypothesis 1  
  
The first hypothesis is that participation levels will be different by sport.  
 
  As shwon in the graph above, the only sport that showed a constant increase in sport particiaption was soccer. Football shows a negative trend, where the number of athletes participating is decreasing year over year. This helps support the hypothesis that the participation change is different by sport. This leads us to question which charactersitics are common among sports with declining participation versus increasing particpation.  
  

  
```{r Cost to Play Mason Kellett, echo=FALSE, message=FALSE, warning=FALSE}
 
cost <- cost %>%
  mutate(Price_Level = as_factor(if_else(Cost > 300, "Expensive","Inexpensive"))) %>%
  select(Sport, Price_Level)

sport %>%
  left_join(cost, by = "Sport") %>%
  pivot_longer(cols = c(Boys,Girls)) %>%
  filter(Sport != "Baseball" | name != "Girls",
         Sport != "Football" | name != "Girls") %>%
  group_by(Price_Level, Year) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  group_by(Price_Level) %>%
  arrange(Year, .by_group = T) %>%
  mutate(pct_change = ((value/lag(value))-1)*100) %>%
  ggplot() +
  geom_smooth(aes(x = Year, y = pct_change, color = Price_Level), size = 2,se = F) +
  geom_hline(yintercept = 0,linetype = "dashed",color = "red")+
  labs(title = "Percent Change in High School Athletes by Cost to Play",
       subtitle = "Compared to Percent Change in Overall High School Students (Black)",
       y = "% Change",
       color = "Price Level",
       caption = "Data provided by NFHS and MetroKids") +
  theme_minimal() +
  scale_color_manual(values = wes_palette(name = "Moonrise2")) +
  theme(legend.position = "bottom")+
  theme(plot.title = element_text(face = "bold",size = 16,hjust = .5)) +
  geom_smooth(data = enroll_pct_change, aes(x = Year, y = pct_change), size = 2, se = F, color = "black") +
  xlim(c(2011,2018))
```

### Hypothesis 2  

 More expensive sports will show a more consistent decline in sport participation. 

  Sports were split into two factors, expensive or inexpensive, depending on the sports average annual cost according to a MetroKids report. Based on this seperation, it was shown that the more expensive sport strayed significantly from the overall trendline for change in student population. The less expensive sports, even in 2018, followed pretty closely with the changes in student population. This leads to the conclusion that students are participating less frequently in sports that are consistently more expensive, which demonstrates how cost is a huge indicator of the decreasing sport participation. 
  
### Hypothesis 3

Sports with higher rates of injury will show a decline in participation.

# Injuries

The main questions I looked into dealt with the potential impact of injuries in high school sports participation. So, within our overall hypothesis, I developed a few more that are specific to injuries.

My hypotheses were as follows:

  1. Contact sports will have a higher number of concussions than limited or no contact sports.
For example, sports like football or soccer would be more likely to result in brain injury than sports like gymnastics.
  2. Gender may be a factor in the overall rate of injuries in high school athletes.
  3. The risk of injury negatively impacts participation in high school sports.


## How many kids are getting hurt?
```{r Youth TBI Carmen}
# Getting rid of total counts
youth_ed_tbi_visits <- youth_ed_tbi_visits %>% 
  filter(Sport != "Total contact count") %>%
  filter(Sport != "Total limited contact count")

# Plotting bar graph
youth_ed_tbi_visits %>% 
  ggplot(aes(x = reorder(Sport, Count))) +
  geom_col(aes(y = Count,
               fill = `Contact Sport`)) +
  ylim(0, 55000) +
  scale_fill_manual(values = c("TRUE" = "#6eb4b8", "FALSE" = "#b8816e")) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Youth Emergency Room Visits among US Children for \nSports-Related Brain Injuries",
       subtitle = "Years: 2010 - 2016",
       caption = "Centers for Disease Control and Prevention (CDC): \n Morbidity and Mortality Weekly Report (March 2019)",
       x = "Sport",
       y = "Count")
```
In order to test my hypothesis that contact sports will have a higher number of concussions, I used data from the CDCâ€™s Morbidity and Mortality Report. As you can see, Football, Basketball, & Soccer make up the majority of youth emergency room visits. Non-contact sports, therefore, appear to be less likely to result in Sports-Related brain injuries.

This suggests that there may be a correlation with participation and concussions, particularly with football.


## What demographics are most affected?
```{r Concussions by Gender Carmen}
# Pivoting longer
num_concussions_2017 <- num_concussions_2017 %>% 
  pivot_longer(cols = c(male, female)) %>% 
  rename(gender = name)

# Plotting Number of Concussions by Gender
num_concussions_2017 %>% 
   ggplot(aes(x = concussions, y = value, fill = gender)) +
   geom_col(position = "dodge") +
  scale_fill_manual(values = c("female" = "#706eb8",
                               "male" = "#91b86e"),
                    name = "Gender") +
  labs(title = "Percent of Concussions in US Youth That Play Sports by Gender",
       subtitle = "Year: 2017",
       caption = "CDC: Self-Reported Concussions from Playing a Sport or Being Physically Active
Among High School Students",
       x = "",
       y = "Percent") +
  theme_minimal()
```
Next, I compared the rates of concussions by gender. It is important to note that nearly 80% of US Youth did not get concussions from sports in 2017 when this survey was conducted. Of those that do, they are likely to only get one concussion, and it appears that males tend to have concussions slightly more often than females.

## What sports have the most injuries?
### Injuries by sport
```{r Combining Injury Totals Carmen}
# Iterating over and combining injury datasets
total_sport_injuries <- map_df(sports_injuries_type, combine_injury_totals)
```

```{r Lengthening Total Sports Injuries Carmen}
# Pivoting total sports injuries longer
total_sport_injuries <- Sport %>% 
  bind_cols(total_sport_injuries) %>% 
  select(-Activity) %>% 
  pivot_longer(cols = -Sport, names_to = "Injury Type", values_to = "Count")
```

```{r Boxplot of Injuries by Sport Carmen}
# Vector of colors
sports_colors <- c("#91b86e", "#956eb8", "#b86e90", "#6eb895", "#b8816e", "#b6b86e", "#706eb8")

# Plotting injuries by sport
total_injuries_boxplot <- total_sport_injuries %>% 
  ggplot(aes(x = Sport, y = Count, fill = Sport)) +
  geom_boxplot() +
  scale_fill_manual(values = sports_colors) +
  scale_y_continuous(breaks = seq(0, 175000, 25000)) +
  theme_minimal()
```

```{r Boxplot of Injuries by Sport Continued Carmen}
# Adding appropriate labels to histogram
total_injuries_boxplot +
  labs(title = "Variations in Amount of Injuries by Sport",
       subtitle = "Year: 2018",
       caption = "Colorado School of Public Health: \n Program for Injury Prevention, Education & Research") + 
  theme(axis.text.x = element_text(size = 7)) 
```

This led me to narrow in my focus, so I looked at the variations in injuries by sport in 2018. One thing I thought was really interesting was that Girlâ€™s Soccer had the second highest mean. From the previous graphs we looked at, boyâ€™s sports tended to have a higher number of injuries, so I had expected boys' contact sports to have higher numbers overall.

Football, though, clearly had the highest count of injuries. This could potentially contribute to public perception that contact sports like football are dangerous.


### Injuries by type
```{r Boxplot of Injuries by Type Carmen}
# Vector of colors
injury_colors <- c("#91b86e", "#956eb8", "#b86e90", "#6eb895", "#b8816e")

# Plotting boxplots of injury types
injury_type_boxplot <- total_sport_injuries %>% 
  ggplot(aes(x = `Injury Type`, y = Count, fill = `Injury Type`)) +
  geom_boxplot() +
  scale_fill_manual(values = injury_colors) +
  scale_y_continuous(breaks = seq(0, 175000, 25000)) +
  theme_minimal()

# Adding labels to graph
injury_type_boxplot +
  labs(title = "Variation in Most Common Injury Types",
       subtitle = "Year 2018",
       caption = "Colorado School of Public Health: \n Program for Injury Prevention, Education & Research")
```

Another variable of interest I looked at was the variation of injury type in 2018. It appears that sprains are the most common injury, followed by concussion.

## How have injuries rates changed over time?
### Diagnosis by year, color by type
```{r Lengthening Diagnosis Table Carmen}
# Pivoting diagnosis dataset
diagnosis_by_year <- diagnosis_by_year %>% 
  rename(Diagnosis = X1) %>% 
  filter(Diagnosis != "Total") %>% 
  pivot_longer(cols = !Diagnosis, names_to = "Year", values_to = "Percent")
```

```{r Formatting Diagnosis Carmen}
# Temporary variable holding all year values
temp_year <- diagnosis_by_year$Year

# Temporary variable holding all percent values
temp_perc <- diagnosis_by_year$Percent

# Using regex to clean observations
temp_year <- temp_year %>% 
  str_replace_all(pattern = ",", replacement = "") %>% 
  str_replace_all(pattern = "[[:punct:]]\\d{2}", replacement = "") %>% 
  as.integer()

# Using regex to get rid of percent sign
temp_perc <- temp_perc %>% 
  str_replace_all(pattern = "%", replacement = "") %>% 
  as.numeric()

# Joining new columns and renaming variables for clarity
diagnosis_by_year <- diagnosis_by_year %>% 
  select(-Year, -Percent) %>% 
  bind_cols(temp_year, temp_perc) %>% 
  rename(Year = `...2`) %>% 
  rename(Percent = `...3`)
```

```{r Scatterplot for Diagnosis by Sport Carmen}
# Creating scatter plot of diagnoses over time by type
diagnosis_time <- diagnosis_by_year %>% 
  ggplot(aes(x = Year, y = Percent, color = Diagnosis)) +
  facet_wrap(~ Diagnosis, scales = "free") +
  geom_point() +
  geom_smooth() +
  scale_color_manual(values = injury_colors) +
  theme_minimal()
```

```{r Scatterplot Formatting Carmen}
# Adding appropriate labels to diagram
diagnosis_time +
  labs(title = "Trends in Injury Diagnosis",
       subtitle = "Years: 2005 - 2018",
       caption = "Colorado School of Public Health: Program for Injury Prevention, Education & Research")
```

The next aspect I analyzed is how injury diagnoses have changed over time. This data comes from the Colorado School of Public Healthâ€™s Program for Injury Prevention, Education & Research, and this study collected data on the main injury diagnoses high school students received from 2005-2018.

Concussions were the only type of injury to see an increase over the course of those 13 years, and it nearly doubled. It is possible that this large increase in concussions has led to a decrease in contact sports.


# Participation
## Who participates in sports?
```{r Map Data Carmen}
# Loading latitude and longitude data
usa_map <- map_data("state")
```

### Boys Participants Map
```{r Boy Participation Carmen}
# Lengthening boys participation data
boys_participation_long <- all_boys_athletes_states %>% 
  pivot_longer(cols = !State, names_to = "Sports", values_to = "Count")

# Making state names lowecase to match `usa_map`
boys_participation_long$State <- tolower(boys_participation_long$State)

# Plotting choropleth map
boys_participation_map <- boys_participation_long %>% 
  ggplot(aes(fill = Count)) +
  geom_map(aes(map_id = State), map = usa_map) +
  expand_limits(x = usa_map$long, y = usa_map$lat) +
  facet_wrap( ~ Sports)
```

```{r Boy Participation Map Carmen}
# Adding labels to map
boys_participation_map +
  theme_void() +
  labs(title = "Counts of Participation in Boy's Sports by State",
       subtitle = "Year: 2018",
       caption = "High School Participation Survey Archive") +
    theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_distiller(palette = "Greens", trans = "reverse")
```

As I started wrapping up my analysis on injury, I began to look at sports participation by gender and by state for 2018. 

Here, we can see the count of participants in 48 of the states, separated by sport. One of the most notable parts of this graph is that it appears the highest number of participants is for football in Texas. This was unexpected to me because of the data we have seen in the past few slides that football has a higher rate of injury.

The next most popular sports appear to be basketball and soccer, both of which had the highest number of participants in Texas and California.


### Boys Programs Availability Map
```{r Boys Programs Carmen}
# Lengthening program data
boys_programs_long <- all_boys_programs_states %>% 
  pivot_longer(cols = !State, names_to = "Sports", values_to = "Count")
  
# Making state names lowercase
boys_programs_long$State <- tolower(boys_programs_long$State)

# Plotting choropleth map
boys_programs_count <- boys_programs_long %>% 
  ggplot(aes(fill = Count)) +
  geom_map(aes(map_id = State), map = usa_map) +
  expand_limits(x = usa_map$long, y = usa_map$lat) +
  facet_wrap( ~ Sports)
```

```{r Boys Programs Map Carmen}
# Adding lables
boys_programs_count +
  theme_void() +
  labs(title = "Counts of Programs for Boy's Sports by State",
       subtitle = "Year: 2018",
       caption = "High School Participation Survey Archive") +
    theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_distiller(palette = "Purples", trans = "reverse")
```

I next looked at the availability of sports programs by state for the same year. As you can see, there tends to be a slightly higher number of programs overall for basketball than for the other sports. 

It is unclear whether sports with high rates of injuries have less programs available through school or travel teams, etc. There are several other factors that could play into the number of programs available like cost.


### Girls Participants Map
```{r Gir Participation Carmen}
# Lengthening girls participation data
girls_participation_long <- girl_athletes_states %>% 
  select(-starts_with("X"), -Football) %>% 
  pivot_longer(cols = !State, names_to = "Sports", values_to = "Count")
  
# Making state names lowercase
girls_participation_long$State <- tolower(girls_participation_long$State)

# Plotting choropleth map
girls_participation_map <- girls_participation_long %>% 
  ggplot(aes(fill = Count)) +
  geom_map(aes(map_id = State), map = usa_map) +
  expand_limits(x = usa_map$long, y = usa_map$lat) +
  facet_wrap( ~ Sports)
```

```{r Girl Participation Map}
# Adding labels
girls_participation_map +
  theme_void() +
  labs(title = "Counts of Participation in Girl's Sports by State",
       subtitle = "Year: 2018",
       caption = "High School Participation Survey Archive") +
    theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_distiller(palette = "Greens", trans = "reverse")
```

The highest number of female participants appears to be for volleyball. This sport had the lowest average injury in the box plots we saw earlier, and this potentially supports our hypothesis as well, as it has lower number of injuries and more participation.

### Girls Progams Map
```{r Girls Programs Carmen}
# Lengthening data
girls_programs_long <- girl_programs_states %>% 
  select(-starts_with("X"), -Football) %>% 
  pivot_longer(cols = !State, names_to = "Sports", values_to = "Count")

# Making state names lowercase
girls_programs_long$State <- tolower(girls_programs_long$State)

# Plotting chropleth map
girls_programs_count <- girls_programs_long %>% 
  ggplot(aes(fill = Count)) +
  geom_map(aes(map_id = State), map = usa_map) +
  expand_limits(x = usa_map$long, y = usa_map$lat) +
  facet_wrap( ~ Sports)
```

```{r Girl Participation Carmen}
# Adding labels
girls_programs_count +
  theme_void() +
  labs(title = "Counts of Programs for Girls's Sports by State",
       subtitle = "Year: 2018",
       caption = "High School Participation Survey Archive") +
    theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  scale_fill_distiller(palette = "Purples", trans = "reverse")
```

Here is the availability of sports programs for girls by state. It appears the states where the highest number of programs are also happen to be for volleyball. It is possible that schools and sports organizations are more likely to invest in sports programs that are less likely to lead to injury.

# Conclusion
## Public opinion
```{r Factor Levels Carmen}
# Vector of statements from survey
text_statements <- c("Players who suffer a head injury should be required to take a minimum set amount of time off from playing to recover.",
                     "Helmets should be changed to better protect against concussions.",
                     "The risks of playing football are widely known and players participate at their own risk.",
                     "There should be a standardized test used to determine if and when injured players at all levels may return to the field.",
                     "Aggressive tackles which are more prone to leading to head injuries should be restricted in youth football.")

# Vector of survey levels
survey_levels <- c(
  "Strongly agree",
  "Somewhat agree",
  "Somewhat disagree",
  "Strongly disagree",
  "Not at all sure"
) %>% 
  as_factor()
```

```{r Lengthening Data Carmen}
# Getting rid of Statement column to convert numbers to percents
survey_interim <- survey_tbi_effects %>% 
  select(-Statement)

# Calculating percentages
data_percentage <- survey_interim %>% 
  apply(2,
        function(x){
          perc <- x / sum(x)
          round(perc, digits = 2)
          })

# Converting to tibble and adding final column so it equals 1
diff_interim <- data_percentage %>% 
  as_tibble() %>% 
  select_if(is.numeric) %>% 
  mutate(sum = rowSums(.[1:5])) %>% 
  mutate(diff = 1 - sum)

# Saving into data_percentage
data_percentage <- diff_interim %>% 
  select(-sum)
  

# Adding the statement column back
data_percentage <- cbind(survey_tbi_effects$Statement, data_percentage) %>% 
  as_tibble()  %>% 
  slice(1:5)


# Renaming column
data_percentage <- data_percentage %>% 
  rename(Statement = `survey_tbi_effects$Statement`)

# Pivot long
long_percentage <- data_percentage %>% 
  pivot_longer(cols = contains("r")) %>% 
  rename(response = name)

```

```{r Stacked Bar Graph Carmen}
# Vector of colors and lavels
set_colors <- c("#91b86e", "#956eb8", "#b86e90", "#6eb895", "#b8816e", "#b6b86e")
xlabels <- c("1", "2", "3", "4", "5")

# Making graph
stacked_survey <- long_percentage %>% 
  ggplot(aes(x = Statement, y = value, fill = response)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = set_colors, name = "Response") +
  scale_x_discrete(labels = xlabels) +
  labs(title = "Survey Responses on The Long-Term Effects of Concussions in Sports",
       subtitle = "2014",
       caption = "Source: Harris Interactive | The Harris Poll #92",
       y = "") +
  theme_light()

stacked_survey
```

Lastly, I felt that one of the best ways to get an idea of how the public views sports-related brain injuries in general was to look at a public opinion poll. This survey was conducted by Harris Interactive and it asked its participants to rate to what extent they agree or disagree with 5 statements.

Some of the main takeaways from this graph are that:

  + A quarter of respondents did not believe in setting a minimum amount of time to recover from brain injuries - instead they felt that helmets and protective gear should be modified to better protect athletes.
  + Additionally, nearly a quarter of respondents felt that risk of injury in football is widely known. So perhaps there is a consensus that the sport itself isnâ€™t going to change, but it is the responsibility of athletes to decide whether or not they will put themselves at risk. This statement in particular really stood out to me as tying back to my hypothesis that risk negatively affects participation.
